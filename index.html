<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://static.vecteezy.com/system/resources/previews/027/149/017/original/spiral-shape-isolated-over-transparent-background-png.png" type="image/png">
    <title>Closed-eye hallucination</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #222;
            color: #fff;
            font-family: 'Roboto', sans-serif;
        }
        #controls {
            scrollbar-width: thin;
            scrollbar-color: #888 #333; 
        }

        #controls::-webkit-scrollbar {
            width: 8px; 
            background-color: #333; 
        }

        #controls::-webkit-scrollbar-thumb {
            background-color: #888;  
            border-radius: 30px;  
            box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.3); 
        }

        #controls::-webkit-scrollbar-thumb:hover {
            background-color: #555;  
        }
        .highlight {
            animation: highlightFadeOut 3s;
      
        }

        @keyframes highlightFadeOut {
            0% {
                background-color: rgba(247, 0, 255, 0.5);
            }
            100% {
                background-color: transparent;
            }
        }

        .tooltip {
            display: none;
            position: absolute;
            left: 2px;
            background-color: #333;
            color: #fff;
            padding: 5px;
            border-radius: 5px;
            font-size: 12px;
            white-space: nowrap;
        }

        .control-group {
            position: relative;
        }
        #controls {
            position: absolute;
            top: 0;
            left: 0;
           
            z-index: 1000;
            display: flex;
            flex-direction: column;
            padding: 20px 5px;
            background-color: #333;
            box-shadow: 2px 0px 5px rgba(0, 0, 0, 0.5);
            height: calc(100% - 100px);
            overflow-y: auto;
            width: 250px;
            visibility: hidden;
        }
        .control-group {
            display: flex;
            margin-bottom: 5px;
    background-color: #444;
    padding: 8px 12px;
    border-radius: 8px;
    box-shadow: 0px 3px 5px rgba(0, 0, 0.1, 0.1);
    justify-content: space-between;
    align-items: center;
        }
        .control-group label, .control-group span {
            font-size: 12px;
            color: #bbbbbbbd;
            margin-bottom: -4px;
            display: block;
            min-width: 17%;
        }
        .control-group span {
            font-size: 16px;
            color: #fff;
            margin-TOP: 1px;
            display: block;
        }
        .control-group input[type="range"] {
            -webkit-appearance: none;
            height: 4px;
            WIDTH: 264%;
            background: #ddd;
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
        }
        .widget-controls{
            width: 135vw !important;
        }
        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #ff4081;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 0 2px rgba(0, 0, 0, 0.2);
        }
        .control-group input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #ff4081;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 0 2px rgba(0, 0, 0, 0.2);
        }
 .control-group span {
         font-size: 10px;
         TEXT-ALIGN: right;
         margin-right: 13px;
        }
     
        #toggleButton, #saveStateButton {
            position: absolute;
            min-width: 126px;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background-color: #d6aebc2e;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
          #randomizeButton, #morphButton {
            position: absolute;
            min-width: 126px;
            bottom: 90px;
            right: 10px;
            z-index: 1000;
            background-color: #642f412e;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .morphControlButton{
            color: red;
            background: #7d52ba;
            width: 10px;
            border: 0px;
            font-size: 0px;
            border-radius: 14px;
            cursor: pointer;
            height: 11px;
            display: block;
    position: absolute;
    right: 12px;
        }
        #saveStateButton {
            top: 50px;
        }
        #randomizeButton {
            bottom: 116px;
        }
        #morphButton {
            bottom: 70px;
        }
        #bpmDisplay {
            position: absolute;
            top: 170px;
            right: 10px;
            z-index: 1000;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 20px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        #mixcloudPlayerContainer {
            position: fixed;
            bottom: 0;
            width: 100%;
            z-index: 1000;
            background-color: #222;
        }
        iframe {
            width: 100%;
            height: 60px;
            border: none;
        }
        .label-control-group{
            margin: 2px 0; 
            color: #bbbbbbbd;
            font-size: 10px;;
        }
    </style>
</head>
<body>
<div id="controls" style="visibility: hidden;">
    <p class="label-control-group" >Controls</p>
    <div class="control-group">
        <label for="backgroundSlider">Alpha</label>
        <span id="backgroundValue">50</span>
        <input type="range" id="backgroundSlider" min="0" max="255" step="2" value="50" data-key-up="2" data-key-down="1" data-key-morph="<">
        <button class="morphControlButton" data-target="backgroundSlider">Morph</button>
    </div>
    <div class="control-group">
        <label for="growthSlider">Growth</label>
        <span id="growthValue">1</span>
        <input type="range" id="growthSlider" min="0.9" max="1.08" step="0.005" value="1" data-key-up="q" data-key-down="a" data-key-morph="z">
        <button class="morphControlButton" data-target="growthSlider">Morph</button>
    </div>
    <div class="control-group">
        <label for="structureSpeedSlider">Speed</label>
        <span id="structureSpeedValue">8</span>
        <input type="range" id="structureSpeedSlider" min="1" max="14" value="8" data-key-up="w" data-key-down="s" data-key-morph="x">
        <button class="morphControlButton" data-target="structureSpeedSlider">Morph</button>
    </div>
  
    <div class="control-group">
        <label for="distortionSlider">Distortion</label>
        <span id="distortionValue">50</span>
        <input type="range" id="distortionSlider" min="0" max="100" value="50" data-key-up="e" data-key-down="d" data-key-morph="c">
        <button class="morphControlButton" data-target="distortionSlider">Morph</button>
    </div>
    <div class="control-group">
        <label for="speedSlider">Rotation</label>
        <span id="speedValue">2</span>
        <input type="range" id="speedSlider" min="-10" max="10" value="2"  step="0.3" data-key-up="r" data-key-down="f" data-key-morph="v">
        <button class="morphControlButton" data-target="speedSlider">Morph</button>
    </div>
    
   
    <p class="label-control-group" >Structure</p>
    <div class="control-group">
        <label for="blurFactorSlider">Revolution</label>
        <span id="blurFactorValue">1</span>
        <input type="range" id="blurFactorSlider" min="0" max="12" value="1" data-key-up="t" data-key-down="g" data-key-morph="b">
        <button class="morphControlButton" data-target="blurFactorSlider">Morph</button>
    </div>
    <div class="control-group">
        <label for="layerSlider">Layers</label>
        <span id="layerValue">10</span>
        <input type="range" id="layerSlider" min="2" max="20" value="10" data-key-up="y" data-key-down="h" data-key-morph="n">
        <button class="morphControlButton" data-target="layerSlider">Morph</button>
    </div>
    <div class="control-group">
        <label for="pointsSlider">Points</label>
        <span id="pointsValue">12</span>
        <input type="range" id="pointsSlider" min="3" max="20" value="12" data-key-up="u" data-key-down="j" data-key-morph="m">
        <button class="morphControlButton" data-target="pointsSlider">Morph</button>
    </div>
    <div class="control-group">
        <label for="polygonPointsSlider">Polygon</label>
        <span id="polygonPointsValue">6</span>
        <input type="range" id="polygonPointsSlider" min="3" max="12" value="6" data-key-up="i" data-key-down="k" data-key-morph=",">
        <button class="morphControlButton" data-target="polygonPointsSlider">Morph</button>
    </div>
    <div class="control-group">
        <label for="strokeWidthSlider">Stroke</label>
        <span id="strokeWidthValue">2</span>
        <input type="range" id="strokeWidthSlider" min="0.1" max="6" value="2" step="0.2" data-key-up="o" data-key-down="l" data-key-morph=".">
        <button class="morphControlButton" data-target="strokeWidthSlider">Morph</button>
    </div>
    
   
    <p class="label-control-group" >Colors</p>
    <div class="control-group">
        
        <label for="saturationSlider">Saturation</label>
        <span id="saturationValue">100</span>
        <input type="range" id="saturationSlider" min="0" max="100" value="100" data-key-up="p" data-key-down="ò" data-key-morph="-">
        <button class="morphControlButton" data-target="saturationSlider">Morph</button>
    </div>
    <div class="control-group">
        <label for="brightnessSlider">Brightness</label>
        <span id="brightnessValue">100</span>
        <input type="range" id="brightnessSlider" min="0" max="100" value="100" data-key-up="è" data-key-down="à" data-key-morph="ù">
        <button class="morphControlButton" data-target="brightnessSlider">Morph</button>
    </div>
    <div class="control-group">
        <label for="lightSlider">Light</label>
        <span id="lightValue">50</span>
        <input type="range" id="lightSlider" min="1" max="100" value="50" data-key-up="'" data-key-down="ì" data-key-morph="+">
        <button class="morphControlButton" data-target="lightSlider">Morph</button>
    </div>
    <div class="control-group">
        <label for="baseHueSlider">Hue</label>
        <span id="baseHueValue">180</span>
        <input type="range" id="baseHueSlider" min="0" max="360" value="180" data-key-up="ArrowRight" data-key-down="ArrowLeft" data-key-morph="ctrl">
        <button class="morphControlButton" data-target="baseHueSlider">Morph</button>
    </div>
    <div class="control-group">
        <label for="colorShiftSlider">Color</label>
        <span id="colorShiftValue">0</span>
        <input type="range" id="colorShiftSlider" min="0" max="360" value="0" data-key-up="ArrowUp" data-key-down="ArrowDown">
        <button class="morphControlButton" data-target="colorShiftSlider">Morph</button>
    </div>
    
    <p class="label-control-group" >Automations</p>
    <div class="control-group">
        <label for="morphVelocitySlider">Morph</label>
        <span id="morphVelocityValue">5</span>
        <input type="range" id="morphVelocitySlider" min="1" max="120" value="5">
          </div>
    <div class="control-group">
        <label for="autoSlider">Auto</label>
        <span id="autoValue">10</span>
        <input type="range" id="autoSlider" min="1" max="1600" value="10" data-key-up="l" data-key-down="k">
        
    </div>
   
 
    <div id="fpsDisplay" style="text-align: left; margin-top: 10px; ; font-size: 10px ; color: #ffffffbd;">FPS: <span id="fpsValue">0</span></div>
 
</div>
<div id="bpmDisplay" style="display: none;"></div>
<button id="toggleButton">Show Controls</button>
<button style="display: none;" id="saveStateButton">Share</button> 
<button title="Press Enter" id="randomizeButton">Morph</button>
<button title="Press Spacebar" id="morphButton">Randomize</button>
<div id="mixcloudPlayerContainer">
    <iframe width="130%" height="60" src="https://player-widget.mixcloud.com/widget/iframe/?hide_cover=1&mini=1&hide_artwork=1&autoplay=1&feed=%2Frydhmdee%2Fcosmic-energy-psytrance-mix-2017-rydhm-dee%2F" frameborder="0" allow="autoplay"></iframe></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
<script>
    let angleOffset = 0;
    let rotationSpeed = 0.02;
    let structureSpeed = 0.08;
    let maxRadius;
    let layerCount = 10;
    let points = 12;
    let distortionFactor = 0.5;
    let backgroundAlpha = 50;
    let strokeWidth = 2;
    let polygonPoints = 6;
    let growth = 1;
    let blurFactor = 4;
    let baseHue = 180;
    let colorShift = 0;
    let saturation = 100;
    let brightness = 100;
    let lightValue = 50;
    let structures = [];  // Define the structures array
  let autoInterval = 10000; // Default 10 seconds (10000 ms)
let autoIntervalId = null;
    let bpm = 0;
    let bpmHistory = [];
    let lastPressTime = 0;
    let morphDuration = 5000;
    let canRandomize = true; // Variable to control randomize button timing
    let lastTime = 0;
let fps = 0;

    function setup() {
        createCanvas(windowWidth, windowHeight);
        maxRadius = min(width, height) / 2;
        noFill();
        structures.push(new Structure(0.1));

        setupControls();
        setupToggleControls();
        setupSaveStateButton();
        setupRandomizeButton();
        setupMorphButton();
      
        // Randomize initial parameters
        randomizeParameters();
    }

    function draw() {
        try {
            background(34, 34, 34, backgroundAlpha);

            structures.forEach((structure, index) => {
                try {
                    structure.update();
                    structure.display();

                    if (structure.isTooLarge()) {
                        structures.splice(index, 1);
                    }
                } catch (e) {
                    console.error('Error in structure update or display:', e);
                }
            });

            if (structures.length === 0 || (structures[structures.length - 1] && structures[structures.length - 1].shouldCreateNew())) {
                try {
                    let lastStructureScale = structures.length > 0 ? structures[structures.length - 1].scaleFactor : 0.1;
                    structures.push(new Structure(lastStructureScale / 2.5));
                } catch (e) {
                    console.error('Error creating new structure:', e);
                }
            }

            angleOffset += rotationSpeed;
            document.getElementById('bpmDisplay').textContent = `BPM: ${bpm}`;
        } catch (e) {
            console.error('Error in draw function:', e);
        }
    }

    class Structure {
    constructor(startScale) {
        this.scaleFactor = startScale;
        this.strokeWeight = strokeWidth;
        this.x = width / 2;
        this.y = height / 2;
    }

    update() {
        this.scaleFactor *= growth;
        this.scaleFactor += structureSpeed;
        this.strokeWeight = map(this.scaleFactor, 1, 4, strokeWidth, 1);
    }

    display() {
        // Check if the structure should be rendered
        if (!this.shouldRender()) {
            return;
        }

        try {
            push();
            translate(this.x, this.y);
            scale(this.scaleFactor);
            strokeWeight(this.strokeWeight);
            drawSymmetricPattern();
            pop();
        } catch (e) {
            console.error('Error in Structure display:', e);
        }
    }

    isTooLarge() {
        return this.scaleFactor > 4;
    }

    shouldCreateNew() {
        return this.scaleFactor > 1.2 && this.scaleFactor < 1.3;
    }

    shouldRender() {
        // Calculate bounding box based on scaleFactor and maxRadius
        let maxSize = this.scaleFactor * maxRadius;
        let minX = this.x - maxSize;
        let maxX = this.x + maxSize;
        let minY = this.y - maxSize;
        let maxY = this.y + maxSize;

        // Check if the bounding box is within the visible canvas
        if (maxX < 0 || minX > width || maxY < 0 || minY > height) {
            return false;
        }

        return true;
    }
}


    function drawSymmetricPattern() {
        try {
            colorMode(HSB, 360, 100, 100, 100);

            for (let i = 0; i < layerCount; i++) {
                let radius = maxRadius * (i / layerCount);
                let psychedelicColor = color(
                    (baseHue + colorShift + map(sin(angleOffset * 4 + i), -1, 1, 0, 360)) % 360, 
                    saturation, 
                    brightness, 
                    lightValue
                );
                stroke(psychedelicColor);

                beginShape();
                for (let j = 0; j < points; j++) {
                    let angle = TWO_PI / points * j + angleOffset;
                    let x = cos(angle) * radius * (1 + distortionFactor * sin(angleOffset + i));
                    let y = sin(angle) * radius * (1 + distortionFactor * cos(angleOffset + i));
                    vertex(x, y);
                    drawPolygon(x, y, radius / 3, psychedelicColor);
                }
                endShape(CLOSE);
            }
        } catch (e) {
            console.error('Error in drawSymmetricPattern:', e);
        }
    }

    function drawPolygon(x, y, size, colorValue) {
        try {
            push();
            translate(x, y);
            stroke(colorValue);
            strokeWeight(strokeWidth);

            size *= growth;

            beginShape();
            for (let i = 0; i < polygonPoints; i++) {
                let angle = TWO_PI / polygonPoints * i + angleOffset * blurFactor;
                let px = cos(angle) * size;
                let py = sin(angle) * size;
                vertex(px, py);
            }
            endShape(CLOSE);

            pop();
        } catch (e) {
            console.error('Error in drawPolygon:', e);
        }
    }

    function windowResized() {
        try {
            resizeCanvas(windowWidth, windowHeight);
            maxRadius = min(width, height) / 2;
        } catch (e) {
            console.error('Error in windowResized:', e);
        }
    }

    function setupControls() {
        const autoSlider = document.getElementById('autoSlider');
    const morphButton = document.getElementById('morphButton');

   
        const morphVelocitySlider = document.getElementById('morphVelocitySlider');
        const speedSlider = document.getElementById('speedSlider');
        const structureSpeedSlider = document.getElementById('structureSpeedSlider');
        const layerSlider = document.getElementById('layerSlider');
        const pointsSlider = document.getElementById('pointsSlider');
        const distortionSlider = document.getElementById('distortionSlider');
        const backgroundSlider = document.getElementById('backgroundSlider');
        const strokeWidthSlider = document.getElementById('strokeWidthSlider');
        const polygonPointsSlider = document.getElementById('polygonPointsSlider');
        const growthSlider = document.getElementById('growthSlider');
        const blurFactorSlider = document.getElementById('blurFactorSlider');
        const baseHueSlider = document.getElementById('baseHueSlider');
        const colorShiftSlider = document.getElementById('colorShiftSlider');
        const saturationSlider = document.getElementById('saturationSlider');
        const brightnessSlider = document.getElementById('brightnessSlider');
        const lightSlider = document.getElementById('lightSlider');

        autoSlider.addEventListener('input', function() {
            updateAutoInterval();
        });

        morphVelocitySlider.addEventListener('input', function() {
            morphDuration = parseInt(morphVelocitySlider.value, 10) * 1000;
            document.getElementById('morphVelocityValue').textContent = morphVelocitySlider.value;
            updateAutoInterval(); // Update auto interval when morph duration changes
        });

        
    startAutoMorph();
        morphDuration = parseInt(morphVelocitySlider.value, 10) * 1000;

        speedSlider.addEventListener('input', function() {
            rotationSpeed = parseFloat(speedSlider.value) / 100;
            document.getElementById('speedValue').textContent = speedSlider.value;
        });

        structureSpeedSlider.addEventListener('input', function() {
            structureSpeed = parseFloat(structureSpeedSlider.value) / 100;
            document.getElementById('structureSpeedValue').textContent = structureSpeedSlider.value;
        });

        layerSlider.addEventListener('input', function() {
            layerCount = parseInt(layerSlider.value, 10);
            document.getElementById('layerValue').textContent = layerSlider.value;
        });

        pointsSlider.addEventListener('input', function() {
            points = parseInt(pointsSlider.value, 10);
            document.getElementById('pointsValue').textContent = pointsSlider.value;
        });

        distortionSlider.addEventListener('input', function() {
            distortionFactor = distortionSlider.value / 100;
            document.getElementById('distortionValue').textContent = distortionSlider.value;
        });

        backgroundSlider.addEventListener('input', function() {
            backgroundAlpha = parseInt(backgroundSlider.value, 10);
            document.getElementById('backgroundValue').textContent = backgroundSlider.value;
        });

        strokeWidthSlider.addEventListener('input', function() {
            strokeWidth = parseInt(strokeWidthSlider.value, 10);
            document.getElementById('strokeWidthValue').textContent = strokeWidthSlider.value;
        });

        polygonPointsSlider.addEventListener('input', function() {
            polygonPoints = parseInt(polygonPointsSlider.value, 10);
            document.getElementById('polygonPointsValue').textContent = polygonPointsSlider.value;
        });

        growthSlider.addEventListener('input', function() {
            growth = parseFloat(growthSlider.value);
            document.getElementById('growthValue').textContent = growthSlider.value;
        });

        blurFactorSlider.addEventListener('input', function() {
            blurFactor = parseInt(blurFactorSlider.value, 10);
            document.getElementById('blurFactorValue').textContent = blurFactorSlider.value;
        });

        baseHueSlider.addEventListener('input', function() {
            baseHue = parseInt(baseHueSlider.value, 10);
            document.getElementById('baseHueValue').textContent = baseHueSlider.value;
        });

        colorShiftSlider.addEventListener('input', function() {
            colorShift = parseInt(colorShiftSlider.value, 10);
            document.getElementById('colorShiftValue').textContent = colorShiftSlider.value;
        });

        saturationSlider.addEventListener('input', function() {
            saturation = parseInt(saturationSlider.value, 10);
            document.getElementById('saturationValue').textContent = saturationSlider.value;
        });

        brightnessSlider.addEventListener('input', function() {
            brightness = parseInt(brightnessSlider.value, 10);
            document.getElementById('brightnessValue').textContent = brightnessSlider.value;
        });

        lightSlider.addEventListener('input', function() {
            lightValue = parseInt(lightSlider.value, 10);
            document.getElementById('lightValue').textContent = lightSlider.value;
        });

        // Initialize values from sliders
        updateValuesFromSliders();
    }

    function updateValuesFromSliders() {
        const speedSlider = document.getElementById('speedSlider');
        const structureSpeedSlider = document.getElementById('structureSpeedSlider');
        const layerSlider = document.getElementById('layerSlider');
        const pointsSlider = document.getElementById('pointsSlider');
        const distortionSlider = document.getElementById('distortionSlider');
        const backgroundSlider = document.getElementById('backgroundSlider');
        const strokeWidthSlider = document.getElementById('strokeWidthSlider');
        const polygonPointsSlider = document.getElementById('polygonPointsSlider');
        const growthSlider = document.getElementById('growthSlider');
        const blurFactorSlider = document.getElementById('blurFactorSlider');
        const baseHueSlider = document.getElementById('baseHueSlider');
        const colorShiftSlider = document.getElementById('colorShiftSlider');
        const saturationSlider = document.getElementById('saturationSlider');
        const brightnessSlider = document.getElementById('brightnessSlider');
        const lightSlider = document.getElementById('lightSlider');

        rotationSpeed = parseFloat(speedSlider.value) / 100;
        structureSpeed = parseFloat(structureSpeedSlider.value) / 100;
        layerCount = parseInt(layerSlider.value, 10);
        points = parseInt(pointsSlider.value, 10);
        distortionFactor = distortionSlider.value / 100;
        backgroundAlpha = parseInt(backgroundSlider.value, 10);
        strokeWidth = parseInt(strokeWidthSlider.value, 2);
        polygonPoints = parseInt(polygonPointsSlider.value, 10);
        growth = parseFloat(growthSlider.value);
        blurFactor = parseInt(blurFactorSlider.value, 10);
        baseHue = parseInt(baseHueSlider.value, 10);
        colorShift = parseInt(colorShiftSlider.value, 10);
        saturation = parseInt(saturationSlider.value, 10);
        brightness = parseInt(brightnessSlider.value, 10);
        lightValue = parseInt(lightSlider.value, 10);
    }

    function updateAutoInterval() {
        const autoSliderValue = parseInt(document.getElementById('autoSlider').value, 10) * 1000;
        autoInterval = autoSliderValue + morphDuration;
        document.getElementById('autoValue').textContent = (autoInterval / 1000).toFixed(1); // Update the label with the total interval in seconds

        // Restart the auto-morph interval
        clearInterval(autoIntervalId);
        startAutoMorph();
    }
    function startAutoMorph() {
        autoIntervalId = setInterval(function() {
            document.getElementById('morphButton').click();
        }, autoInterval);
    }

    function setupToggleControls() {
        const toggleButton = document.getElementById('toggleButton');
        const controls = document.getElementById('controls');

        toggleButton.addEventListener('click', function() {
            if (controls.style.visibility === 'hidden') {
                controls.style.visibility = 'visible';
                toggleButton.textContent = 'Hide Controls';
            } else {
                controls.style.visibility = 'hidden';
                toggleButton.textContent = 'Show Controls';
            }
        });
    }

    function setupSaveStateButton() {
        const saveStateButton = document.getElementById('saveStateButton');

        saveStateButton.addEventListener('click', function() {
            const params = new URLSearchParams({
                speed: document.getElementById('speedSlider').value,
                structureSpeed: document.getElementById('structureSpeedSlider').value,
                layers: document.getElementById('layerSlider').value,
                points: document.getElementById('pointsSlider').value,
                distortion: document.getElementById('distortionSlider').value,
                background: document.getElementById('backgroundSlider').value,
                strokeWidth: document.getElementById('strokeWidthSlider').value,
                polygonPoints: document.getElementById('polygonPointsSlider').value,
                growth: document.getElementById('growthSlider').value,
                blurFactor: document.getElementById('blurFactorSlider').value,
                baseHue: document.getElementById('baseHueSlider').value,
                colorShift: document.getElementById('colorShiftSlider').value,
                saturation: document.getElementById('saturationSlider').value,
                brightness: document.getElementById('brightnessSlider').value,
                light: document.getElementById('lightSlider').value
            });

            const url = `${window.location.origin}${window.location.pathname}?${params.toString()}`;
            window.prompt("Copy this link to share the current settings:", url);
        });
    }

    function setupRandomizeButton() {
        const randomizeButton = document.getElementById('randomizeButton');

        randomizeButton.addEventListener('click', function() {
        
const morphControlButtons = document.querySelectorAll('.morphControlButton');           
           
      // Hide the buttons
             morphButton.style.display = 'none';
            randomizeButton.style.display = 'none';
            morphControlButtons.forEach(button => {
    button.style.display = 'none';
});
            setTimeout(() => {
                morphButton.style.display = 'block';
            randomizeButton.style.display = 'block';
            morphControlButtons.forEach(button => {
        button.style.display = 'block';
    });
            }, morphDuration); // 10 seconds

            // Smooth transition to random values
            smoothTransition(document.getElementById('speedSlider'), getRandomValue(-10, 10));
            smoothTransition(document.getElementById('structureSpeedSlider'), getRandomValue(1, 11));
            smoothTransition(document.getElementById('layerSlider'), getRandomValue(2, 14));
           // 
            smoothTransition(document.getElementById('distortionSlider'), getRandomValue(0, 100));
            smoothTransition(document.getElementById('backgroundSlider'), getRandomValue(0, 140));
            smoothTransition(document.getElementById('strokeWidthSlider'), getRandomValue(1, 5));
            smoothTransition(document.getElementById('polygonPointsSlider'), getRandomValue(5, 12));
            smoothTransition(document.getElementById('growthSlider'), (Math.random() * (1.08 - 0.9) + 0.9).toFixed(2));
            smoothTransition(document.getElementById('blurFactorSlider'), getRandomValue(2, 8));
            smoothTransition(document.getElementById('baseHueSlider'), getRandomValue(0, 360));
            smoothTransition(document.getElementById('colorShiftSlider'), getRandomValue(0, 360));
            smoothTransition(document.getElementById('saturationSlider'), getRandomValue(2, 100));
            smoothTransition(document.getElementById('brightnessSlider'), getRandomValue(2, 100));
            smoothTransition(document.getElementById('lightSlider'), getRandomValue(2, 100));
            if (getRandomValue(1,10) == 1){
                        smoothTransition(document.getElementById('pointsSlider'), getRandomValue(3, 20));
            }
        });
             
        
    }

    function setupMorphButton() {
    const morphButton = document.getElementById('morphButton');
    const randomizeButton = document.getElementById('randomizeButton');

    morphButton.addEventListener('click', function() {
      

        // Instantly set random values without smooth transition
        document.getElementById('speedSlider').value = getRandomValue(-10, 10);
        document.getElementById('structureSpeedSlider').value = getRandomValue(1, 14);
        document.getElementById('layerSlider').value = getRandomValue(2, 14);
        document.getElementById('pointsSlider').value = getRandomValue(5, 20);
        document.getElementById('distortionSlider').value = getRandomValue(0, 100);
        document.getElementById('backgroundSlider').value = getRandomValue(0, 255);
        document.getElementById('strokeWidthSlider').value = getRandomValue(1, 4);
        document.getElementById('polygonPointsSlider').value = getRandomValue(3, 12);
        document.getElementById('growthSlider').value = (Math.random() * (1.08 - 0.9) + 0.9).toFixed(2);
        document.getElementById('blurFactorSlider').value = getRandomValue(2, 8);
        document.getElementById('baseHueSlider').value = getRandomValue(0, 360);
        document.getElementById('colorShiftSlider').value = getRandomValue(0, 360);
        document.getElementById('saturationSlider').value = getRandomValue(2, 100);
        document.getElementById('brightnessSlider').value = getRandomValue(2, 100);
        document.getElementById('lightSlider').value = getRandomValue(2, 100);

        // Trigger input events to apply changes
        const sliders = document.querySelectorAll('input[type="range"]');
        sliders.forEach(slider => slider.dispatchEvent(new Event('input')));

 
    });
}


function smoothTransition(slider, targetValue) {
        const currentValue = parseFloat(slider.value);
        const steps = 100;
        const stepTime = morphDuration / steps;
        const valueIncrement = (targetValue - currentValue) / steps;

        let stepCount = 0;
        const interval = setInterval(() => {
            stepCount++;
            slider.value = currentValue + valueIncrement * stepCount;
            slider.dispatchEvent(new Event('input'));

            if (stepCount >= steps) {
                clearInterval(interval);
            }
        }, stepTime);
    }

    function calculateFPS() {
    const currentTime = performance.now();
    fps = Math.round(1000 / (currentTime - lastTime));
    lastTime = currentTime;
    document.getElementById('fpsValue').textContent = fps;
}
function startAutoMorph() {
    autoIntervalId = setInterval(function() {
        if (document.getElementById('randomizeButton').style.display !== 'none'){
           document.getElementById('randomizeButton').click();
        }
    }, autoInterval);
}

function calculateFPS() {
    const currentTime = performance.now();
    fps = Math.round(1000 / (currentTime - lastTime));
    lastTime = currentTime;
    document.getElementById('fpsValue').textContent = fps;
}

function draw() {
    try {
        calculateFPS(); // Calculate FPS for each frame

        background(34, 34, 34, backgroundAlpha);

        structures.forEach((structure, index) => {
            try {
                structure.update();
                structure.display();

                if (structure.isTooLarge()) {
                    structures.splice(index, 1);
                }
            } catch (e) {
                console.error('Error in structure update or display:', e);
            }
        });

        if (structures.length === 0 || (structures[structures.length - 1] && structures[structures.length - 1].shouldCreateNew())) {
            try {
                let lastStructureScale = structures.length > 0 ? structures[structures.length - 1].scaleFactor : 0.1;
                structures.push(new Structure(lastStructureScale / 2.5));
            } catch (e) {
                console.error('Error creating new structure:', e);
            }
        }

        angleOffset += rotationSpeed;
        document.getElementById('bpmDisplay').textContent = `BPM: ${bpm}`;
    } catch (e) {
        console.error('Error in draw function:', e);
    }
}

    // Function to highlight a control group
    function highlightControlGroup(controlGroup) {
        controlGroup.classList.add('highlight');
        setTimeout(() => {
            controlGroup.classList.remove('highlight');
        }, 1000); // 1 second highlight duration
    }

    // Updated individual Morph button implementation
    document.querySelectorAll('.morphControlButton').forEach(button => {
        button.addEventListener('click', function() {
            const targetId = button.getAttribute('data-target');
            const slider = document.getElementById(targetId);
            const controlGroup = button.parentElement;

            // Highlight the control group
            highlightControlGroup(controlGroup);

            // Set a random value for the corresponding slider
            let randomValue = getRandomValueForSlider(targetId);
            smoothTransition(slider, randomValue);

            // Hide the button while morphing
            button.style.display = 'none';

            // Show the button again after morphing
            setTimeout(() => {
                button.style.display = 'block';
            }, morphDuration);
        });
    });

    // Function to get a random value for each slider
    function getRandomValueForSlider(targetId) {
        if (targetId === 'backgroundSlider') {
            return getRandomValue(0, 140);
        } else if (targetId === 'growthSlider') {
            return (Math.random() * (1.08 - 0.9) + 0.9).toFixed(2);
        } else if (targetId === 'structureSpeedSlider') {
            return getRandomValue(1, 14);
        } else if (targetId === 'speedSlider') {
            return 0;
        } else if (targetId === 'distortionSlider') {
            return getRandomValue(0, 100);
        } else if (targetId === 'blurFactorSlider') {
            return getRandomValue(0, 12);
        } else if (targetId === 'layerSlider') {
            return getRandomValue(2, 20);
        } else if (targetId === 'pointsSlider') {
            return getRandomValue(3, 20);
        } else if (targetId === 'polygonPointsSlider') {
            return getRandomValue(3, 12);
        } else if (targetId === 'strokeWidthSlider') {
            return getRandomValue(1, 6);
        } else if (targetId === 'saturationSlider') {
            return getRandomValue(0, 100);
        } else if (targetId === 'brightnessSlider') {
            return getRandomValue(0, 100);
        } else if (targetId === 'lightSlider') {
            return getRandomValue(1, 100);
        } else if (targetId === 'baseHueSlider') {
            return getRandomValue(0, 360);
        } else if (targetId === 'colorShiftSlider') {
            return getRandomValue(0, 360);
        } else if (targetId === 'morphVelocitySlider') {
            return getRandomValue(1, 20);
        }
        return 0;
    }

   

    function getRandomValue(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

   
    function randomizeParameters() {
        if (document.getElementById('randomizeButton').style.display !== 'none'){
             document.getElementById('randomizeButton').click();
        }
    }
   //document.addEventListener('keydown', function(event) {
   //    const controlGroups = document.querySelectorAll('.control-group');
   //    
   //    controlGroups.forEach(group => {
   //        const slider = group.querySelector('input[type="range"]');
   //        const morphButton = group.querySelector('.morphControlButton');
   //        const keyUp = slider.getAttribute('data-key-up');
   //        const keyDown = slider.getAttribute('data-key-down');
   //        const keyMorph = slider.getAttribute('data-key-morph');

   //        if (event.key === keyUp) {
   //            adjustSlider(slider.id, 1);
   //        } else if (event.key === keyDown) {
   //            adjustSlider(slider.id, -1);
   //        } else if (event.key === keyMorph) {
   //            morphButton.click();
   //        }
   //    });

   //    if (event.key === 'Enter') {
   //        document.getElementById('randomizeButton').click();
   //    } else if (event.key === '') {
   //        document.getElementById('morphButton').click();
   //    } else if (event.key === '\\') {
   //        document.getElementById('toggleButton').click();
   //    }
   //});

   let pressedKeys = {};
   document.addEventListener('keydown', function(event) {
    pressedKeys[event.key] = true; // Mark this key as pressed
    handleKeyPresses();
});

document.addEventListener('keyup', function(event) {
    delete pressedKeys[event.key]; // Remove the key from pressed keys
});

function handleKeyPresses() {
    const controlGroups = document.querySelectorAll('.control-group');

    controlGroups.forEach(group => {
        const slider = group.querySelector('input[type="range"]');
        const keyUp = slider.getAttribute('data-key-up');
        const keyDown = slider.getAttribute('data-key-down');
        const keyMorph = slider.getAttribute('data-key-morph');
        const morphButton = group.querySelector('.morphControlButton');

        if (pressedKeys[keyUp]) {
            adjustSlider(slider.id, 1);
            highlightControlGroup(group); // Highlight the control group
        }
        if (pressedKeys[keyDown]) {
            adjustSlider(slider.id, -1);
            highlightControlGroup(group); // Highlight the control group
        }
        if (pressedKeys[keyMorph] && morphButton.style.display !== 'none') {
            morphButton.click();
        }
    });

    if (pressedKeys['Enter'] && document.getElementById('randomizeButton').style.display !== 'none') {
        document.getElementById('randomizeButton').click();
    } else if (pressedKeys[' '] && document.getElementById('morphButton').style.display !== 'none')  {
        document.getElementById('morphButton').click();
    } else if (pressedKeys['\\']) {
        document.getElementById('toggleButton').click();
    }
}

function adjustSlider(sliderId, step) {
    const slider = document.getElementById(sliderId);
    slider.value = parseFloat(slider.value) + step * parseFloat(slider.step || 1);
    slider.dispatchEvent(new Event('input'));
}

function highlightControlGroup(controlGroup) {
    controlGroup.classList.add('highlight');
    setTimeout(() => {
        controlGroup.classList.remove('highlight');
    }, 1000); // 1 second highlight duration
}

// Tooltip logic for displaying key hints
const controlGroups = document.querySelectorAll('.control-group');
controlGroups.forEach(group => {
    const tooltip = document.createElement('div');
    tooltip.className = 'tooltip';
    tooltip.textContent = `Key: ${group.querySelector('input').dataset.keyUp} / ${group.querySelector('input').dataset.keyDown}`;
    group.appendChild(tooltip);

    group.addEventListener('mouseover', function() {
        tooltip.style.display = 'block';
        tooltip.style.width = '18%';
        tooltip.style.overflow   = 'hidden';
    });
    group.addEventListener('mouseout', function() {
        tooltip.style.display = 'none';
    });
});
 

function adjustSlider(sliderId, step) {
    const slider = document.getElementById(sliderId);
    slider.value = parseFloat(slider.value) + step * parseFloat(slider.step || 1);
    slider.dispatchEvent(new Event('input'));
}

    // Smooth transition function (already in your code)
    function smoothTransition(slider, targetValue) {
        const currentValue = parseFloat(slider.value);
        const duration = morphDuration; // 5 seconds
        const steps = 100;
        const stepTime = duration / steps;
        const valueIncrement = (targetValue - currentValue) / steps;

        let stepCount = 0;
        const interval = setInterval(() => {
            stepCount++;
            slider.value = currentValue + valueIncrement * stepCount;
            slider.dispatchEvent(new Event('input'));

            if (stepCount >= steps) {
                clearInterval(interval);
            }
        }, stepTime);
    }

    // Function for randomizing the values
    function getRandomValue(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    // Individual Morph button implementation
    document.querySelectorAll('.morphControlButton').forEach(button => {
        button.addEventListener('click', function() {
            const targetId = button.getAttribute('data-target');
            const slider = document.getElementById(targetId);

            // Hide the button while morphing
            button.style.display = 'none';

            // Set a random value for the corresponding slider
            let randomValue;
            backgroundSlider
            if (targetId === 'backgroundSlider') {
                randomValue = getRandomValue(0, 30);
            } else if (targetId === 'growthSlider') {
                randomValue = (Math.random() * (1.08 - 0.9) + 0.9).toFixed(2);
            } else if (targetId === 'structureSpeedSlider') {
                randomValue = getRandomValue(1, 14);
            } else if (targetId === 'speedSlider') {
                randomValue = 0;
            } else if (targetId === 'distortionSlider') {
                randomValue = getRandomValue(0, 100);
            } else if (targetId === 'blurFactorSlider') {
                randomValue = getRandomValue(0, 12);
            } else if (targetId === 'layerSlider') {
                randomValue = getRandomValue(2, 20);
            } else if (targetId === 'pointsSlider') {
                randomValue = getRandomValue(3, 20);
            } else if (targetId === 'polygonPointsSlider') {
                randomValue = getRandomValue(3, 12);
            } else if (targetId === 'strokeWidthSlider') {
                randomValue = getRandomValue(1, 6);
            } else if (targetId === 'saturationSlider') {
                randomValue = getRandomValue(0, 100);
            } else if (targetId === 'brightnessSlider') {
                randomValue = getRandomValue(0, 100);
            } else if (targetId === 'lightSlider') {
                randomValue = getRandomValue(1, 100);
            } else if (targetId === 'baseHueSlider') {
                randomValue = getRandomValue(0, 360);
            } else if (targetId === 'colorShiftSlider') {
                randomValue = getRandomValue(0, 360);
            }

            smoothTransition(slider, randomValue);

            // Show the button again after morphing
            setTimeout(() => {
                button.style.display = 'block';
            }, morphDuration); // Adjust the timeout duration as needed
        });
    });
   
</script>
</body>
</html>
